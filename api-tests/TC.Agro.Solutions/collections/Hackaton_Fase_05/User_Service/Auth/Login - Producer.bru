meta {
  name: Login - Producer
  type: http
  seq: 4
}

post {
  url: {{identity_service_url}}/auth/login
  body: json
  auth: inherit
}

body:json {
  {
      "email": "ricardocavalcantesilva@gmail.com",
      "password": "Ricardo@123"
  }
}

script:post-response {
  // Garante que a resposta √© JSON
  const responseJson = res.getBody();
  
  // Verifica status HTTP
  const status = res.getStatus();
  
  if (status !== 200 && status !== 201) {
      console.log("‚ö†Ô∏è Requisi√ß√£o n√£o retornou sucesso:", status);
      return;
  }
  
  // Valida√ß√£o segura
  if (!responseJson || typeof responseJson !== "object") {
      throw new Error("‚ùå Resposta n√£o √© JSON v√°lido");
  }
  
  const newToken = responseJson.jwtToken;
  
  // Valida√ß√£o do token
  if (!newToken || typeof newToken !== "string" || newToken.length === 0) {
      throw new Error("‚ùå Token inv√°lido ou ausente na resposta");
  }
  
  // Set env var
  bru.setEnvVar("admin_token", newToken);
  
  console.log("‚úÖ Token atualizado com sucesso!");
  console.log("üîë Novo token:", newToken);
  
  // Testes
  assert(newToken, "Token deve existir");
  assert(newToken.length > 0, "Token n√£o pode ser vazio");
  
}

settings {
  encodeUrl: true
  timeout: 0
}
