# =====================================================
# TC Agro Solutions - Development Local Override
# =====================================================
# This file extends docker-compose.yml with development-specific configurations.
# Docker Compose automatically loads this file if it exists.
#
# Usage:
#   - docker compose up          (uses both .yml and .override.yml)
#   - docker compose -f docker-compose.yml up  (ignores this override)
#
# Development Features Enabled:
#   - Hot-reload (code volumes)
#   - Debug ports for Visual Studio
#   - Verbose logging
#   - Faster rebuilds
# =====================================================

services:
  # =====================================================
  # DATABASE - Enhanced for Development
  # =====================================================
  postgres:
    # Increase log output for debugging
    environment:
      - POSTGRES_INITDB_ARGS=-c log_statement=all -c log_duration=on
    # Keep existing volumes + add backups
    volumes:
      - postgres_backups:/var/lib/postgresql/backups

  # =====================================================
  # CACHE - Enhanced for Development
  # =====================================================
  redis:
    # Enable verbose logging for development
    command: >
      redis-server
      --appendonly yes
      --save 60 1000
      --loglevel verbose
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru

  # =====================================================
  # MESSAGE BROKER - Enhanced for Development
  # =====================================================
  rabbitmq:
    environment:
      # Increase log level for debugging
      - RABBITMQ_LOGS=-
      - RABBITMQ_SASL_LOGS=-

  # =====================================================
  # OBSERVABILITY - Loki Enhanced
  # =====================================================
  loki:
    environment:
      # No additional configs needed, runs as-is
      # But can be overridden if needed
      LOKI_LOGGING_LEVEL: debug

  # =====================================================
  # OBSERVABILITY - Tempo Enhanced
  # =====================================================
  tempo:
    environment:
      TEMPO_LOGGING_LEVEL: debug

  # =====================================================
  # OBSERVABILITY - Prometheus Enhanced
  # =====================================================
  prometheus:
    # More frequent scraping for faster feedback
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=7d" # Shorter retention in dev
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
      - "--web.enable-lifecycle"
      - "--query.max-samples=1000000" # Allow more samples for dev

  # =====================================================
  # OBSERVABILITY - OpenTelemetry Collector Enhanced
  # =====================================================
  otel-collector:
    environment:
      OTEL_LOGGING_LEVEL: debug

  # =====================================================
  # OBSERVABILITY - Grafana Enhanced
  # =====================================================
  grafana:
    environment:
      # Disable plugin security for easier development
      GF_SECURITY_ALLOW_EMBED_INIT_STATE_IN_VIEW: "true"
      GF_PANELS_DISABLE_SANITIZE_HTML: "true"
      GF_EXPLORE_ENABLED: "true"
      # Set default home dashboard refresh
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: /var/lib/grafana/dashboards/home.json

  # =====================================================
  # SERVICE - Identity Service (Development Mode)
  # =====================================================
  tc-agro-identity-service:
    # ⚠️ IMPORTANT: Override 'image:' to use local build (not Docker Hub)
    image: tc-agro-identity-service:dev-local
    restart: "no"
    # Override build configuration for development
    build:
      context: ../../
      dockerfile: services/identity-service/src/Adapters/Inbound/TC.Agro.Identity.Service/Dockerfile
      args:
        BUILD_CONFIGURATION: Debug # Debug build instead of Release

    # Add debug port for Visual Studio debugger
    ports:
      - "5001:8080" # HTTP
      - "5011:8081" # HTTPS
      - "15001:15001" # VS Debugger port (if configured in Dockerfile)

    # Enhanced environment for development
    environment:
      # ASP.NET Core - Development settings
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DOTNET_USE_POLLING_FILE_WATCHER=1
      - DOTNET_WATCH_RESTART_ON_RUDE_EDIT=1

      # Verbose logging for development
      - Serilog__MinimumLevel__Default=Debug
      - Serilog__MinimumLevel__Override__Microsoft=Information
      - Serilog__MinimumLevel__Override__System=Information

      # Telemetry (Grafana Agent) - Use value from .env
      - Telemetry__Grafana__Agent__Enabled=${TELEMETRY_GRAFANA_AGENT_ENABLED}

    # Enable hot-reload: map source code as volume
    volumes:
      # Source code volume for hot-reload
      # Uncomment the line below to enable live code editing
      # When uncommented, changes to code are reflected immediately
      # - ../../services/identity-service/src:/app/src:ro

      # Keep logs volume
      - identity_logs:/app/logs

      # NuGet cache for faster builds
      - identity_nuget_cache:/root/.nuget/packages

    # Faster restart on code changes
    # restart: on-failure:3

    # Override: Remove otel-collector dependency for development
    # Reason: Telemetry (Grafana Agent) is optional for development
    #
    # To enable Grafana Agent dependency when needed:
    # Set environment variable Telemetry__Grafana__Agent__Enabled=true
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  # =====================================================
  # FRONTEND - Development Mode
  # =====================================================
  tc-agro-frontend-service:
    # ⚠️ IMPORTANT: Override 'image:' to use local build (not Docker Hub)
    image: tc-agro-frontend-service:dev-local
    restart: "no"
    build:
      context: ../../poc/frontend
      dockerfile: Dockerfile
      args:
        VITE_BASE_PATH: /
      # Force rebuild on every docker-compose up (uncomment if needed)
      # no_cache: true
    ports:
      - "5010:8080"
    # No additional environment variables needed for static frontend
    # Nginx serves pre-built static files

  # =====================================================
  # SERVICE - Farm Service (Development Mode)
  # =====================================================
  tc-agro-farm-service:
    image: tc-agro-farm-service:dev-local
    restart: "no"
    build:
      context: ../../
      dockerfile: services/farm-service/src/Adapters/Inbound/TC.Agro.Farm.Service/Dockerfile
      args:
        BUILD_CONFIGURATION: Debug
    ports:
      - "5002:8080" # HTTP
      - "5012:8081" # HTTPS
      - "15002:15001" # VS Debugger port
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DOTNET_USE_POLLING_FILE_WATCHER=1
      - DOTNET_WATCH_RESTART_ON_RUDE_EDIT=1
      - Serilog__MinimumLevel__Default=Debug
      - Serilog__MinimumLevel__Override__Microsoft=Information
      - Serilog__MinimumLevel__Override__System=Information
      - Telemetry__Grafana__Agent__Enabled=${TELEMETRY_GRAFANA_AGENT_ENABLED}
    volumes:
      - farm_logs:/app/logs
      - farm_nuget_cache:/root/.nuget/packages
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  # =====================================================
  # FUTURE SERVICES - Development Placeholders
  # =====================================================
  # Sensor Ingest Service - Development Mode
  tc-agro-sensor-ingest-service:
    image: tc-agro-sensor-ingest-service:dev-local
    restart: "no"
    build:
      context: ../../
      dockerfile: services/sensor-ingest-service/src/Adapters/Inbound/TC.Agro.SensorIngest.Service/Dockerfile
      args:
        BUILD_CONFIGURATION: Debug
    ports:
      - "5003:8080" # HTTP
      - "5013:8081" # HTTPS
      - "15003:15001" # VS Debugger port
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DOTNET_USE_POLLING_FILE_WATCHER=1
      - DOTNET_WATCH_RESTART_ON_RUDE_EDIT=1
      - Serilog__MinimumLevel__Default=Debug
      - Serilog__MinimumLevel__Override__Microsoft=Information
      - Serilog__MinimumLevel__Override__System=Information
      - Telemetry__Grafana__Agent__Enabled=${TELEMETRY_GRAFANA_AGENT_ENABLED}
    volumes:
      - sensor_ingest_logs:/app/logs
      - sensor_ingest_nuget_cache:/root/.nuget/packages
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  # Analytics Worker - Development Mode
  tc-agro-analytics-worker:
    image: tc-agro-analytics-worker:dev-local
    restart: "no"
    build:
      context: ../../
      dockerfile: services/analytics-worker/src/Adapters/Inbound/TC.Agro.Analytics.Service/Dockerfile
      args:
        BUILD_CONFIGURATION: Debug
    ports:
      - "5004:8080" # HTTP
      - "5014:8081" # HTTPS
      - "15004:15001" # VS Debugger port
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DOTNET_USE_POLLING_FILE_WATCHER=1
      - DOTNET_WATCH_RESTART_ON_RUDE_EDIT=1
      - Serilog__MinimumLevel__Default=Debug
      - Serilog__MinimumLevel__Override__Microsoft=Information
      - Serilog__MinimumLevel__Override__System=Information
      - Telemetry__Grafana__Agent__Enabled=${TELEMETRY_GRAFANA_AGENT_ENABLED}
    volumes:
      - analytics_logs:/app/logs
      - analytics_worker_nuget_cache:/root/.nuget/packages
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

# =====================================================
# VOLUMES - Development Additional Volumes
# =====================================================
volumes:
  # PostgreSQL backups for development
  postgres_backups:
    name: tc-agro-postgres-backups

  # NuGet package cache for faster builds
  identity_nuget_cache:
    name: tc-agro-identity-nuget-cache

  # Farm Service cache
  farm_nuget_cache:
    name: tc-agro-farm-nuget-cache
  sensor_ingest_nuget_cache:
    name: tc-agro-sensor-ingest-nuget-cache
  analytics_worker_nuget_cache:
    name: tc-agro-analytics-worker-nuget-cache
