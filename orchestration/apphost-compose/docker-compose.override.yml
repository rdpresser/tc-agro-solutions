# =====================================================
# TC Agro Solutions - Development Local Override
# =====================================================
# This file extends docker-compose.yml with development-specific configurations.
# Docker Compose automatically loads this file if it exists.
#
# Usage:
#   - docker compose up          (uses both .yml and .override.yml)
#   - docker compose -f docker-compose.yml up  (ignores this override)
#
# Development Features Enabled:
#   - Hot-reload (code volumes)
#   - Debug ports for Visual Studio
#   - Verbose logging
#   - Faster rebuilds
# =====================================================

services:
  # =====================================================
  # DATABASE - Enhanced for Development
  # =====================================================
  postgres:
    # Increase log output for debugging
    environment:
      - POSTGRES_INITDB_ARGS=-c log_statement=all -c log_duration=on
    # Keep existing volumes + add backups
    volumes:
      - postgres_backups:/var/lib/postgresql/backups

  # =====================================================
  # CACHE - Enhanced for Development
  # =====================================================
  redis:
    # Enable verbose logging for development
    command: >
      redis-server
      --appendonly yes
      --save 60 1000
      --loglevel verbose
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru

  # =====================================================
  # MESSAGE BROKER - Enhanced for Development
  # =====================================================
  rabbitmq:
    environment:
      # Increase log level for debugging
      - RABBITMQ_LOGS=-
      - RABBITMQ_SASL_LOGS=-

  # =====================================================
  # OBSERVABILITY - Loki Enhanced
  # =====================================================
  loki:
    environment:
      # No additional configs needed, runs as-is
      # But can be overridden if needed
      LOKI_LOGGING_LEVEL: debug

  # =====================================================
  # OBSERVABILITY - Tempo Enhanced
  # =====================================================
  tempo:
    environment:
      TEMPO_LOGGING_LEVEL: debug

  # =====================================================
  # OBSERVABILITY - Prometheus Enhanced
  # =====================================================
  prometheus:
    # More frequent scraping for faster feedback
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=7d" # Shorter retention in dev
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
      - "--web.enable-lifecycle"
      - "--query.max-samples=1000000" # Allow more samples for dev

  # =====================================================
  # OBSERVABILITY - OpenTelemetry Collector Enhanced
  # =====================================================
  otel-collector:
    environment:
      OTEL_LOGGING_LEVEL: debug

  # =====================================================
  # OBSERVABILITY - Grafana Enhanced
  # =====================================================
  grafana:
    environment:
      # Disable plugin security for easier development
      GF_SECURITY_ALLOW_EMBED_INIT_STATE_IN_VIEW: "true"
      GF_PANELS_DISABLE_SANITIZE_HTML: "true"
      GF_EXPLORE_ENABLED: "true"
      # Set default home dashboard refresh
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: /var/lib/grafana/dashboards/home.json

  # =====================================================
  # SERVICE - Identity Service (Development Mode)
  # =====================================================
  tc-agro-identity-service:
    restart: "no"
    # Override build configuration for development
    build:
      context: ../../
      dockerfile: services/identity-service/src/Adapters/Inbound/TC.Agro.Identity.Service/Dockerfile
      args:
        BUILD_CONFIGURATION: Debug # Debug build instead of Release

    # Add debug port for Visual Studio debugger
    ports:
      - "5001:8080" # HTTP
      - "5011:8081" # HTTPS
      - "15001:15001" # VS Debugger port (if configured in Dockerfile)

    # Enhanced environment for development
    environment:
      # ASP.NET Core - Development settings
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DOTNET_USE_POLLING_FILE_WATCHER=1
      - DOTNET_WATCH_RESTART_ON_RUDE_EDIT=1

      # Verbose logging for development
      - Serilog__MinimumLevel__Default=Debug
      - Serilog__MinimumLevel__Override__Microsoft=Information
      - Serilog__MinimumLevel__Override__System=Information

      # Console output for debugging
      - Serilog__WriteTo__0__Name=Console

      # Disable OpenTelemetry by default for development
      - OpenTelemetry__Enabled=false

    # Enable hot-reload: map source code as volume
    volumes:
      # Source code volume for hot-reload
      # Uncomment the line below to enable live code editing
      # When uncommented, changes to code are reflected immediately
      # - ../../services/identity-service/src:/app/src:ro

      # Keep logs volume
      - identity_logs:/app/logs

      # NuGet cache for faster builds
      - identity_nuget_cache:/root/.nuget/packages

    # Faster restart on code changes
    # restart: on-failure:3

    # Override: Remove otel-collector dependency for development
    # Reason: OpenTelemetry is optional for development
    #
    # To enable OTEL Collector dependency when needed:
    # Set environment variable OpenTelemetry__Enabled=true
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  # =====================================================
  # FUTURE SERVICES - Development Placeholders
  # =====================================================

  # # Farm Service - Development Mode (Uncomment when ready)
  # tc-agro-farm-service:
  #   build:
  #     context: ../../
  #     dockerfile: services/farm-service/src/Adapters/Inbound/TC.Agro.Farm.Service/Dockerfile
  #     args:
  #       BUILD_CONFIGURATION: Debug
  #   ports:
  #     - "5002:8080"
  #     - "15002:15001"  # Debug port
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Development
  #     - DOTNET_USE_POLLING_FILE_WATCHER=1
  #     - DOTNET_WATCH_RESTART_ON_RUDE_EDIT=1
  #     - Serilog__MinimumLevel__Default=Debug
  #   volumes:
  #     # - ../../services/farm-service/src:/app/src:ro
  #     - farm_nuget_cache:/root/.nuget/packages
  #   restart: on-failure:3

  # # Sensor Ingest Service - Development Mode (Uncomment when ready)
  # tc-agro-sensor-ingest-service:
  #   build:
  #     context: ../../
  #     dockerfile: services/sensor-ingest-service/src/Adapters/Inbound/TC.Agro.SensorIngest.Service/Dockerfile
  #     args:
  #       BUILD_CONFIGURATION: Debug
  #   ports:
  #     - "5003:8080"
  #     - "15003:15001"  # Debug port
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Development
  #     - DOTNET_USE_POLLING_FILE_WATCHER=1
  #     - DOTNET_WATCH_RESTART_ON_RUDE_EDIT=1
  #     - Serilog__MinimumLevel__Default=Debug
  #   volumes:
  #     # - ../../services/sensor-ingest-service/src:/app/src:ro
  #     - sensor_ingest_nuget_cache:/root/.nuget/packages
  #   restart: on-failure:3

  # # Analytics Worker - Development Mode (Uncomment when ready)
  # tc-agro-analytics-worker:
  #   build:
  #     context: ../../
  #     dockerfile: services/analytics-worker/src/TC.Agro.AnalyticsWorker/Dockerfile
  #     args:
  #       BUILD_CONFIGURATION: Debug
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Development
  #     - DOTNET_USE_POLLING_FILE_WATCHER=1
  #     - DOTNET_WATCH_RESTART_ON_RUDE_EDIT=1
  #     - Serilog__MinimumLevel__Default=Debug
  #   volumes:
  #     # - ../../services/analytics-worker/src:/app/src:ro
  #     - analytics_worker_nuget_cache:/root/.nuget/packages
  #   restart: on-failure:3

  # # Dashboard Service - Development Mode (Uncomment when ready)
  # tc-agro-dashboard-service:
  #   build:
  #     context: ../../
  #     dockerfile: services/dashboard-service/src/Adapters/Inbound/TC.Agro.Dashboard.Service/Dockerfile
  #     args:
  #       BUILD_CONFIGURATION: Debug
  #   ports:
  #     - "5005:8080"
  #     - "15005:15001"  # Debug port
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Development
  #     - DOTNET_USE_POLLING_FILE_WATCHER=1
  #     - DOTNET_WATCH_RESTART_ON_RUDE_EDIT=1
  #     - Serilog__MinimumLevel__Default=Debug
  #   volumes:
  #     # - ../../services/dashboard-service/src:/app/src:ro
  #     - dashboard_nuget_cache:/root/.nuget/packages
  #   restart: on-failure:3

# =====================================================
# VOLUMES - Development Additional Volumes
# =====================================================
volumes:
  # PostgreSQL backups for development
  postgres_backups:
    name: tc-agro-postgres-backups

  # NuGet package cache for faster builds
  identity_nuget_cache:
    name: tc-agro-identity-nuget-cache

  # Uncomment for additional services
  # farm_nuget_cache:
  #   name: tc-agro-farm-nuget-cache
  # sensor_ingest_nuget_cache:
  #   name: tc-agro-sensor-ingest-nuget-cache
  # analytics_worker_nuget_cache:
  #   name: tc-agro-analytics-worker-nuget-cache
  # dashboard_nuget_cache:
  #   name: tc-agro-dashboard-nuget-cache
