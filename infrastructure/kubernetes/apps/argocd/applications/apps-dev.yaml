# =====================================================
# ArgoCD Application - Microservices Deployments
# =====================================================
# Purpose: GitOps orchestration for all microservices
# This ApplicationSet syncs Kubernetes manifests to the cluster
#
# üìÅ Configuration Location:
#   - Manifests: infrastructure/kubernetes/apps/base/{service}/
#   - Overlays:  infrastructure/kubernetes/apps/overlays/dev/
#   - Kustomize: overlays/dev/kustomization.yaml (orchestrates all services)
#
# üìä Currently Deployed Services:
#   ‚úÖ frontend (Dashboard UI)
#   ‚úÖ identity-service (Authentication & Authorization)
#   ‚úÖ farm-service (Property and Plot Management)
#   ‚úÖ sensor-ingest-service (Sensor Ingestion)
#   ‚úÖ analytics-worker (Alerts and Rules Processing)
#   üìã dashboard-service (Future - pending Dockerfile)
#
# üîÑ How It Works:
#   1. ArgoCD watches this file for changes
#   2. Reads generators ‚Üí gets path to overlays/dev
#   3. Overlays/dev/kustomization.yaml lists all service manifests
#   4. Kustomize merges all app service manifests + HPA configs
#   5. ArgoCD applies merged manifests to agro-apps namespace
#
# üìñ See Also:
#   - infrastructure/kubernetes/apps/README.md (detailed structure)
#   - infrastructure/kubernetes/apps/base/{service}/ (individual configs)
#   - infrastructure/kubernetes/apps/overlays/dev/kustomization.yaml (orchestration)
# =====================================================

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: agro-apps
  namespace: argocd
  labels:
    project: apps
    environment: dev
spec:
  generators:
    # List generator: single element pointing to Kustomize overlay
    # (overlay orchestrates multiple services via Kustomize)
    - list:
        elements:
          - name: apps
            path: infrastructure/kubernetes/apps/overlays/dev
  
  template:
    metadata:
      name: 'apps-dev'
      namespace: argocd
      labels:
        project: apps
        component: '{{name}}'
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    
    spec:
      project: apps
      
      source:
        repoURL: https://github.com/rdpresser/tc-agro-solutions.git
        targetRevision: main
        path: '{{path}}'  # Points to overlays/dev
      
      destination:
        server: https://kubernetes.default.svc
        namespace: agro-apps
      
      syncPolicy:
        # Continuous reconciliation: ArgoCD syncs changes automatically
        automated:
          prune: true      # Delete resources removed from manifests
          selfHeal: true   # Reconcile if cluster state drifts
          allowEmpty: false
        syncOptions:
          - CreateNamespace=true
          - PrunePropagationPolicy=foreground
          - PruneLast=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
      
      revisionHistoryLimit: 3

